# Настройка ролей в Keycloak

## Проблема: Роли не назначаются при регистрации

Если при регистрации пользователя роль не назначается, проверьте следующее:

## Шаг 1: Убедитесь, что роли существуют в Realm

1. Откройте Keycloak Admin Console: http://localhost:8080
2. Войдите как `admin` / `admin`
3. Выберите realm `microservices-realm`
4. Перейдите в **Realm roles** (в меню слева)
5. Проверьте, что существуют роли:
   - `client`
   - `teacher`
   - `admin` (опционально, для администраторов)

### Если ролей нет - создайте их:

1. Нажмите **Create role**
2. Введите имя роли (например, `client`)
3. Нажмите **Save**
4. Повторите для всех необходимых ролей

## Шаг 2: Проверьте назначение ролей пользователю

1. Перейдите в **Users**
2. Найдите пользователя, который зарегистрировался
3. Откройте вкладку **Role mapping**
4. В разделе **Assigned roles** должны быть назначенные роли
5. Если ролей нет:
   - Нажмите **Assign role**
   - Выберите **Filter by realm roles**
   - Выберите нужную роль (например, `client` или `teacher`)
   - Нажмите **Assign**

## Шаг 3: Проверьте Mapper для ролей

Роли должны быть включены в токен через mapper:

1. Перейдите в **Clients** → **microservices-client**
2. Вкладка **Client scopes**
3. Откройте **microservices-client-dedicated** (или **realm-default**)
4. Вкладка **Mappers**
5. Должен быть mapper типа **"Realm roles"** с настройками:
   - **Token Claim Name**: `realm_access.roles`
   - **Add to ID token**: `ON`
   - **Add to access token**: `ON`
   - **Add to userinfo**: `ON`
   - **Multivalued**: `ON`

Если mapper отсутствует, создайте его:
- **Create mapper** → **By configuration** → **Realm roles**
- Настройте как указано выше

## Шаг 4: Проверьте логи регистрации

После регистрации проверьте логи file-service:

```bash
docker-compose logs file-service | grep -i "role"
```

Или если запущено локально, проверьте консоль приложения.

Должны быть сообщения:
- `✅ Role 'client' successfully assigned to user '...'`
- `✅ Verified: Role 'client' is assigned to user '...'`

Если видите ошибки:
- `Role 'client' not found in realm` - создайте роль в Keycloak (Шаг 1)
- `Failed to assign role` - проверьте права доступа admin пользователя

## Шаг 5: Получите новый токен

После назначения роли пользователю:

1. **Выйдите** из приложения
2. **Войдите снова** с учетными данными зарегистрированного пользователя
3. Проверьте токен в консоли браузера:
   ```javascript
   console.log(window.keycloak.tokenParsed.realm_access?.roles);
   ```
   Должна быть роль в массиве (например, `["client"]` или `["teacher"]`)

## Автоматическая проверка ролей

Код регистрации теперь:
- ✅ Проверяет существование роли перед назначением
- ✅ Логирует подробную информацию о процессе
- ✅ Проверяет назначение роли после операции
- ✅ Возвращает информацию об успехе/неудаче назначения роли

## Устранение проблем

### Роль не назначается автоматически

1. Проверьте логи file-service на наличие ошибок
2. Убедитесь, что роль существует в Keycloak realm
3. Проверьте, что admin пользователь Keycloak имеет права на назначение ролей
4. Назначьте роль вручную через Keycloak UI (Шаг 2)

### Роль назначена, но не видна в токене

1. Проверьте mapper (Шаг 3)
2. Получите новый токен (Шаг 5)
3. Проверьте, что mapper включен в client scopes

### Пользователь не может войти после регистрации

1. Убедитесь, что пароль установлен (`temporary: false`)
2. Проверьте, что `emailVerified: true`
3. Проверьте, что пользователь `enabled: true`

